from threading import Thread
from threading import Semaphore
from threading import Lock
from threading import Condition
import time
import datetime
import random
import threading

fzona = open("Zona_Comun.txt","w")
fmontana = open("Montana_rusa.txt","w")
fcasa = open("Casa_Terror.txt","w")
fcarrusel = open("Carrusel.txt","w")
fbarco = open("Barco_Pirata.txt","w")
fsalida = open("Salida.txt", "w")


NTHREAD = 10
tiemponow = datetime.datetime.now() #para luego hacer los txt pedidos con el tiempo corresondiente
tiempo = str(tiemponow)[11:]
semFilaMontana = Semaphore(10)
semJuegoMontana = Semaphore(10)
semFilaCasa = Semaphore(8)
semFilaCasaAux = Semaphore(2)
semFilaCarrusel = Semaphore(15)
semFilaCarAux = Semaphore(5)
semFilaBarco = Semaphore(6)
semFilaBarAux = Semaphore(3)
cv1 = Condition()
cv2 = Condition()
cv3 = Condition()
cv4 = Condition()
cv4a = Condition()
cv5 = Condition()
cv6 = Condition()
cv6a = Condition()
cv7 = Condition()
cv8 = Condition()
cv8a = Condition()
Lock = Lock() #Se crea la variable lock

filazonacomun = 0
contMontana = 0
filaMontana = 0
filaCasa = 0
contCasa = 0
filaCarrusel = 0
contCarrusel = 0
filaBarco = 0
contBarco = 0

dispMontana = True
dispCasa = True
dispCarrusel = True
dispBarco = True



def MontanaRusa(contador):
    global filaMontana
    global dispMontana
    global contMontana
    tiempoa = ""
    
    with cv1:
        tiempoantes = datetime.datetime.now() 
        tiempoa = str(tiempoantes)[11:]  #Almaceno tiempo

        while (filaMontana < 10):   #Mientras la fila sea menor a 10, personas esperan en la fila

            #if (filazonacomun == 0 and contMontana == 0): Esta parte era para cuando se acaben los jugadores y tengan que entrar noma, pero no funca
            #    filaMontana = 10
            #    print("waos")
            #   break

            cv1.wait()  #Pausa el proceso
        
        if (filaMontana == 10):  #Existen 10 en la fila
            dispMontana = False  #Pauso las entradas a la fila
            cv1.notify() #Notifico al while previo que se puede continuar
            Lock.acquire()
            time.sleep(0.9)
            Lock.release()
            tiempodesp = datetime.datetime.now()
            tiempod = str(tiempodesp)[11:]  #Almaceno tiempo

            Lock.acquire()
            string = threading.current_thread().name + "," + tiempoa + "," + tiempod + "," + str(contador) + "\n"
            fmontana.write(string) #Creo string y lo almaceno en txt
            Lock.release()
        
            return
    




def CasaTerror(contador):
    global filaCasa
    global dispCasa
    global contCasa
    tiempoa = ""
    tiempoantes = datetime.datetime.now()
    tiempoa = str(tiempoantes)[11:]
    while (filaCasa == 8):  #Si la fila es de 8 personas, se bloquea entrada de mas gente, creo que esto ta malo XD
        dispCasa = False
        with cv4:
            cv4.wait()  #Pauso procesos


    if (contCasa <= 2):  # Si hay 2 o menos personas en la fila puede entrar al juego
        semFilaCasaAux.acquire()  #Agarro semaforo con limite de 2 personas
        contCasa += 1  #Contador de cuantas personas estan en el Juego
        filaCasa -= 1  #Resto personas a la fila
        tiempodesp = datetime.datetime.now()
        tiempod = str(tiempodesp)[11:]
        while (contCasa != 2):
            if (filaCasa == 0 and filazonacomun == 0): #Si no hay nadie mas esperando
                contCasa = 2
                break
            with cv4a:
                cv4a.wait()

        
        if (contCasa == 2):  #Si hay 2 personas se continua
            Lock.acquire()
            time.sleep(2.5)  #Se duerme el tiempo que dura el juego, si no se usa esto el proceso no funciona muere
            Lock.release()
            with cv4a:
                cv4a.notify() #Notifico a la persona esperando que puede ingresar
            with cv4:
                cv4.notify() #Notifico a la fila que se puede continuar con mas gente
            Lock.acquire()
            string = threading.current_thread().name + ", " + tiempoa + ", " + tiempod + ", " + str(contador) + "\n"
            fcasa.write(string) #Creo string para ingresar a txt
            Lock.release()
            
        

def Carrusel(contador):
    global filaCarrusel
    global dispCarrusel
    global contCarrusel
    tiempoa = ""
    tiempoantes = datetime.datetime.now()
    tiempoa = str(tiempoantes)[11:]
    while (filaCarrusel == 15):  #Si la fila es de 8 personas, se bloquea entrada de mas gente, creo que esto ta malo XD
        dispCarrusel = False
        with cv6:
            cv6.wait()  #Pauso procesos


    if (contCarrusel <= 5):  # Si hay 2 o menos personas en la fila puede entrar al juego
        semFilaCarAux.acquire()  #Agarro semaforo con limite de 2 personas
        contCarrusel += 1  #Contador de cuantas personas estan en el Juego
        filaCarrusel -= 1  #Resto personas a la fila
        tiempodesp = datetime.datetime.now()
        tiempod = str(tiempodesp)[11:]
        while (contCarrusel != 5):
            if (filaCarrusel == 0 and filazonacomun == 0): #Si no hay nadie mas esperando
                contCarrusel = 5
                break
            with cv6a:
                cv6a.wait()

        
        if (contCarrusel == 5):  #Si hay 2 personas se continua
            Lock.acquire()
            time.sleep(1.4)  #Se duerme el tiempo que dura el juego, si no se usa esto el proceso no funciona muere
            Lock.release()
            with cv6a:
                cv6a.notify() #Notifico a la persona esperando que puede ingresar
            with cv6:
                cv6.notify() #Notifico a la fila que se puede continuar con mas gente
            Lock.acquire()
            string = threading.current_thread().name + "," + tiempoa + "," + tiempod + "," + str(contador) + "\n"
            fcarrusel.write(string) #Creo string para ingresar a txt
            Lock.release()
            return
        
def BarcoPirata(contador):
    global filaBarco
    global dispBarco
    global contBarco
    tiempoa = ""
    tiempoantes = datetime.datetime.now()
    tiempoa = str(tiempoantes)[11:]
    while (filaBarco == 6):  #Si la fila es de 8 personas, se bloquea entrada de mas gente, creo que esto ta malo XD
        dispBarco = False
        with cv8:
            cv8.wait()  #Pauso procesos


    if (contBarco <= 3):  # Si hay 2 o menos personas en la fila puede entrar al juego
        semFilaBarAux.acquire()  #Agarro semaforo con limite de 2 personas
        contBarco += 1  #Contador de cuantas personas estan en el Juego
        filaBarco -= 1  #Resto personas a la fila
        tiempodesp = datetime.datetime.now()
        tiempod = str(tiempodesp)[11:]
        while (contBarco != 3):
            if (filaBarco == 0 and filazonacomun == 0): #Si no hay nadie mas esperando
                contBarco = 3
                break
            with cv8a:
                cv8a.wait()

        
        if (contBarco == 3):  #Si hay 2 personas se continua
            Lock.acquire()
            time.sleep(1.333333)  #Se duerme el tiempo que dura el juego, si no se usa esto el proceso no funciona muere
            Lock.release()
            with cv8a:
                cv8a.notify() #Notifico a la persona esperando que puede ingresar
            with cv8:
                cv8.notify() #Notifico a la fila que se puede continuar con mas gente
            Lock.acquire()
            string = threading.current_thread().name + "," + tiempoa + "," + tiempod + "," + str(contador) + "\n"
            fbarco.write(string) #Creo string para ingresar a txt
            Lock.release()
            return
    


def ZonaComun():
    fzona.write(threading.currentThread().name + ' '+ tiempo)
    Juegos = ["Montaña Rusa", "Casa de Terror", "Carrusel", "Barco Pirata"]  #Lista de juegos
    Juegos2 = Juegos
    contador = 0
    while (contador < 2):
        global filazonacomun
        global filaMontana
        global filaCasa
        global filaCarrusel
        global filaBarco
        global dispMontana
        global dispCasa
        global dispCarrusel
        global dispBarco
        global contMontana
        global contCasa
        global contCarrusel
        global contBarco
        

        Lock.acquire()
        filazonacomun += 1
        Lock.release()
        
        #Se eligen os dos juegos aleatoriamente de la persona o hebra (sin que se repita el mismo juego)
        JuegoAleatorio1 = random.choice(Juegos2)
        
        
        Juegos2.remove(JuegoAleatorio1)
        
        JuegosIdos = [] #Lista de jeugos a los que ha ido
        JuegosIdos.append(JuegoAleatorio1)
        
        #print(threading.currentThread().name + " entro al juego " + JuegoAleatorio1)
        
        if(JuegoAleatorio1 == "Montaña Rusa"):
            
            while (dispMontana == False and contMontana != 0): #Si no hay espacio en la fila, espero hasta poder entrar
                with cv2:
                    cv2.wait()
                

            if (dispMontana == True): #Si hay espacio en la fila, agarro semaforo y entro
                semFilaMontana.acquire()
                Lock.acquire()
                contador += 1 #Contador de juegos
                contMontana += 1 #Cont gente para el juego
                filaMontana += 1 #Cont gente en la fila
                fzona.write(', Montaña Rusa '+ tiempo+' ')
            
                filazonacomun -= 1
                Lock.release()
                MontanaRusa(contador)
                Lock.acquire()
                contMontana -= 1 #Se baja una persona del juego
                Lock.release()

                if (contMontana == 0): #Si no quedan mas personas, solo entra el ultimo jugador
                    dispMontana = True #Se permite entrada de gente a la fila
                    filaMontana = 0 #Se resetea fila

                    with cv2:
                        cv2.notify_all() #Despauso entrada de gente
                    semFilaMontana.release() #Libero recursos del semaforo
                
                while (contMontana != 0): #Otros jugadores
                    with cv2:
                        cv2.wait()  #Esperan hasta que el ultimo jugador se baje
                    semFilaMontana.release() #Liberan recursos
                    
            fmontana.write("\n")

                
            
        elif(JuegoAleatorio1 == "Casa de Terror"):
            
            while (dispCasa == False): #Si no hay espacio en la fila, esperan
                with cv3:
                    cv3.wait()
                

            if (dispCasa == True):
                semFilaCasa.acquire() #Agarra puesto en la fila
                fzona.write(', Casa de Terror '+ tiempo+' ')
            
                contador += 1
                Lock.acquire()
                filaCasa += 1
                filazonacomun -= 1
                Lock.release()
                CasaTerror(contador)
                
                Lock.acquire()
                contCasa -= 1 #Se baja persona del juego
                Lock.release()
                
                if (contCasa == 0): #Si no quedan mas jugadores en la fila
                    with cv3:
                        cv3.notify_all() #Libero fila por si esta bloqueada
                    dispCasa = True 
                    semFilaCasaAux.release() #Libero recursos de semaforos
                    semFilaCasa.release()
                
                while (contCasa == 1):
                    with cv3:
                        cv3.wait()
                    semFilaCasa.release()
                    semFilaCasaAux.release()
            fcasa.write("\n")
                
                    
            
        elif(JuegoAleatorio1 == "Carrusel"): 
            while (dispCarrusel == False): #Si no hay espacio en la fila, esperan
                with cv5:
                    cv5.wait()
                

            if (dispCarrusel == True):
                semFilaCarrusel.acquire() #Agarra puesto en la fila
                fzona.write(', Carrusel '+ tiempo+' ')
                contador += 1
                Lock.acquire()
                filaCarrusel += 1
                filazonacomun -= 1
                Lock.release()
                Carrusel(contador)
                
                Lock.acquire()
                contCarrusel -= 1 #Se baja persona del juego
                Lock.release()
                
                if (contCarrusel == 0): #Si no quedan mas jugadores en la fila
                    with cv5:
                        cv5.notify_all() #Libero fila por si esta bloqueada
                    dispCarrusel = True 
                    semFilaCarAux.release() #Libero recursos de semaforos
                    semFilaCarrusel.release()
                
                while (contCarrusel == 1):
                    with cv5:
                        cv5.wait()
                    semFilaCarrusel.release()
                    semFilaCarAux.release()
            fcarrusel.write("\n")

                
            
        elif(JuegoAleatorio1 == "Barco Pirata"):
            while (dispBarco == False): #Si no hay espacio en la fila, esperan
                with cv7:
                    cv7.wait()
                

            if (dispBarco == True):
                semFilaBarco.acquire() #Agarra puesto en la fila
                fzona.write(', Barco Pirata '+ tiempo+' ')
            
                contador += 1
                Lock.acquire()
                filaBarco += 1
                filazonacomun -= 1
                Lock.release()
                BarcoPirata(contador)
                
                Lock.acquire()
                contBarco -= 1 #Se baja persona del juego
                Lock.release()
                
                if (contBarco == 0): #Si no quedan mas jugadores en la fila
                    with cv7:
                        cv7.notify_all() #Libero fila por si esta bloqueada
                    dispBarco = True 
                    semFilaBarAux.release() #Libero recursos de semaforos
                    semFilaBarco.release()
                
                while (contBarco == 1):
                    with cv7:
                        cv7.wait()
                    semFilaBarco.release()
                    semFilaBarAux.release()
            fbarco.write("\n")

    
    fsalida.write(threading.currentThread().name + ', ' + tiempo + '\n')
    fzona.close()
    fmontana.close()
    fcasa.close()
    fcarrusel.close()
    fbarco.close()
    fsalida.close()

        


     

i = 0
while(i < NTHREAD):
    
    #Se crea la hebra
    NPERSONA ='Persona' + str(i+1)
    threading.Thread(name=NPERSONA, target=ZonaComun, args=( )).start()
    
    i+=1
    
